<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Web Platform Test Dashboard | Test the Web Forward</title>
    <!--Library code -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script src="js/lib/d3.js" charset="utf-8"></script>
    <script src="js/lib/queue.v1.js"></script>
    <script src="js/lib/d3.tip.v0.6.6.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">

    <!-- Styles from http://testthewebforward.org/ -->
    <link rel="stylesheet" href="css/custom.css" type="text/css" media="screen">
    <!-- Visualization Styles -->
    <link rel="stylesheet" href="css/vis.css" type="text/css" media="screen">

    <!--Vis code-->
    <script src="js/processData.js"></script>
    <script src="js/specvis.js"></script>
    <script src="js/whovis.js"></script>
    <script src="js/timelinevis.js"></script>
    <script src="js/filterui.js"></script>
</head>
<body>

<div class="container">
    <h1>Web Platform Tests Dashboard</h1>

        <div style="float:left" id="specVis"></div>
        <div id="filterUI"></div>
        <div id="whoVis"></div>
        <div id="timelineVis"></div>

</div>



<script>
    $(document).ready(function() {
        //Global data variables
        var caniuse = [];
        var groups = [];
        var specs = [];
        var tests = [];
        var allData = {caniuse: [], groups: [], specs: [], tests: []};

        var initVis = function () {
            //Handles timeline brushing
            var brushHandler = {};
            //Handles sunburst selection changing
            var selectionHandler = {};
            //Handles whovis author selection changing
            var authorHandler = {};
            //Handles filter options from UI
            var filterHandler = {};

            //Create visualizations
            spec_vis = new SpecVis(d3.select("#specVis"), allData, selectionHandler);
            who_vis = new WhoVis(d3.select("#whoVis"), allData, authorHandler);
            timeline_vis = new TimelineVis(d3.select("#timelineVis"), allData, brushHandler);
            //filter_ui = new FilterUI(d3.select("#filterUI"), allData, filterHandler);

            //Wire up event handlers
            $(brushHandler).bind("brushChanged", function (event, selectionStart, selectionEnd) {
                spec_vis.onTimelineChange(selectionStart, selectionEnd);
                who_vis.onTimelineChange(selectionStart, selectionEnd);
            });
            $(selectionHandler).bind("selectionChanged", function (event, specSelection) {
                timeline_vis.onSelectionChange(specSelection);
                who_vis.onSelectionChange(specSelection);
                console.log(specSelection);
            });
            $(authorHandler).bind("authorChanged", function (event, author) {
                spec_vis.onAuthorChange(author);
                timeline_vis.onAuthorChange(author);
            });
            $(filterHandler).bind("filterChanged", function(event, filters) {
                //spec_vis.onFilterChange(filters);
                //timeline_vis.onFilterChange(filters);
                //who_vis.onFilterChange(filters);
                console.log(filters);
            });
        };
        var dataLoaded = function (error, _caniuse, _groups, _specs, _tests) {
            if (!error) {
                //See processData.js
                allData = processData(_caniuse, _groups, _specs, _tests);

                //log the data structures, remove for production
                // logData();
                initVis();
            } else {
                console.log("Error loading data!:" + error);
            }
        };
        var init = function () {
            //asynchronously load data
            queue()
                    .defer(d3.json, "data/caniuse.json")
                    .defer(d3.json, "data/groups.json")
                    .defer(d3.json, "data/specs.json")
                    .defer(d3.json, "data/tests.json")
                    .await(dataLoaded);
        };
        init();
    });
</script>
</body>
</html>
